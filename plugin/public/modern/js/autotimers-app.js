/*! For license information please see autotimers-app.js.LICENSE.txt */
!function(){"use strict";function e(e=""){const t=document.createElement("textarea");return t.innerHTML=e,t.value}function t(e){let t=[];return Array.isArray(e)?t=e:void 0!==e&&(t=[e]),t}function a(e,t){const{hours:a=0,minutes:n=0}=t;try{const t=e.split(":"),o=parseInt(t[0]),s=parseInt(t[1]),r=new Date(0,0,0,o,s);return r.setHours(o+a),r.setMinutes(s+n),r.toLocaleTimeString([],{hour12:!1,hour:"2-digit",minute:"2-digit"})}catch(t){return e}}function n(e){document.querySelectorAll(e).forEach((e=>{e.remove()}))}function o(e,t,a,n){const o=t.namedItem(a);if(o)if(owif.utils.debugLog(`[${o.type}]`,o,a,n),o instanceof RadioNodeList){const e=n.split(",");for(const[t,s]of o.entries()){s.value=e[t]||"";try{s.dispatchEvent(new Event("change"))}catch(e){owif.utils.debugLog(a,n,e)}}}else{switch(o.type){case"checkbox":n=!0===n||"True"===n||n.toString()===o.value,o.checked=n;break;case"select-multiple":try{const t=n.map((e=>e.sRef));e.autoTimerChoices[a].setChoices(n,"sRef","name",!1).setChoices(n,"label","value",!1).removeActiveItems().setChoiceByValue(n).setChoiceByValue(t)}catch(e){owif.utils.debugLog(a,n,e)}break;default:o.value=n}try{o.dispatchEvent(new Event("change"))}catch(e){owif.utils.debugLog(a,n,e)}}else if(owif.utils.debugLog("%c[N/A]","color: red",a,n),"filters"!==a){const e=document.createElement("input");e.type="hidden",e.name=a,e.value=n,e.dataset.valueType=typeof n,t[0].form.prepend(e)}}function s(e,t){try{e.classList.toggle("dependent-section--disabled",t),e.querySelectorAll("input, select").forEach((e=>{e.disabled=t}))}catch(e){}}class r{constructor(a){const n=this;if(Object.assign(n,a),n.name=e(n.name),n.match=e(n.match),n.tag=[],n.bouquets=[],n.services=[],n.filters={include:[],exclude:[]},n.enabled="yes"===n.enabled?1:0,n.from&&(n.timespanFrom=n.from,delete n.from),n.to&&(n.timespanTo=n.to,delete n.to),n.after){const e=new Date(1e3*parseInt(n.after));n.after=e.toISOString().split("T")[0]}if(n.before){const e=new Date(1e3*parseInt(n.before));n.before=e.toISOString().split("T")[0]}if(n.afterevent){const e={shutdown:"deepstandby"},t=n.afterevent.from,a=n.afterevent.to,o=n.afterevent["_@ttribute"];t&&(n.aftereventFrom=t),a&&(n.aftereventTo=a),o&&(n.afterevent=e[o]||o)}if(n.e2service){let e=!1;t(n.e2service).forEach(((t,a)=>{const o=owif.utils.isBouquet(t.e2servicereference)?"bouquets":"services";n[o].push({sRef:t.e2servicereference,name:t.e2servicename,selected:!0}),e=!t.e2servicename})),n.hasMismatchedService=e,delete n.e2service}n.e2tag&&(n.tag=t(n.e2tag),delete n.e2tag),n.e2tags&&(n.tag||(n.tag=n.e2tags.split(" ")),delete n.e2tags),n.include&&(n.filters.include=t(n.include),delete n.include),n.exclude&&(n.filters.exclude=t(n.exclude),delete n.exclude),n.vps_safemode=!n.vps_overwrite,"yes"===n.always_zap||"1"===n.always_zap||!0===n.always_zap?(n.justplay=!0,n.always_zap=!0):"yes"===n.justplay||"1"===n.justplay||!0===n.justplay?(n.justplay=!0,n.always_zap=!1):(n.always_zap=!0,n.justplay=!1)}get bouquetSRefs(){return this.bouquets.map((e=>e.sRef))}get bouquetNames(){return this.bouquets.map((e=>e.name))}get channelSRefs(){return this.services.map((e=>e.sRef))}get channelNames(){return this.services.map((e=>e.name))}get isRestrictedByDay(){return this.filters.include.filter((e=>"dayofweek"===e.where)).length+this.filters.exclude.filter((e=>"dayofweek"===e.where)).length>0}}(new function(){let e;const i=document.querySelector('form[name="atedit"]'),l=document.querySelector('form[name="atsettings"]'),c=(e,t="")=>{const a=e.insertCell();return a.innerHTML=t,a};return{getAll:async()=>{const a=(await owif.utils.fetchData("/autotimer")).autotimer;return owif.utils.debugLog(a),e.allAutoTimers=t(a.timer),e.allAutoTimers.map((e=>new r(e))),e.allAutoTimers.sort(function(e,t="asc"){return function(a,n){if(!a.hasOwnProperty(e)||!n.hasOwnProperty(e))return 0;const o="string"==typeof a[e]?a[e].toUpperCase():a[e],s="string"==typeof n[e]?n[e].toUpperCase():n[e];let r=0;return o>s?r=1:o<s&&(r=-1),"desc"===t?-1*r:r}}("name")),e.allAutoTimers},populateList:()=>{const t=document.getElementById("at__list");n(".at__item"),document.getElementById("at__page--edit").classList.toggle("hidden",!0),window.scroll({top:0,left:0,behavior:"smooth"}),document.getElementById("at__page--list").classList.toggle("hidden",!1);const a=document.getElementById("autotimer-list-item-template");let o=[],s=[];e.getAll().then((n=>{n.forEach(((n,i)=>{(n=new r(n)).location&&o.push(n.location),s=s.concat(n.tag);const l=valueLabelMap.autoTimers.searchType[n.searchType]||"",c=a.content.firstElementChild.cloneNode(!0);c.querySelector('[name="preview"]').onclick=t=>e.preview(n.id),c.querySelector('[name="rename"]').onclick=t=>e.renameEntry(n.id,n.name);const u=c.querySelector('a[href="/#/at/edit?id={{id}}"]');u.href=u.href.replace("{{id}}",n.id),u.onclick=t=>{e.editEntry(n.id)},c.querySelector('button[name="toggle"]').onclick=t=>e.toggleEntryEnabled(n.id,n.enabled),c.querySelector('button[name="delete"]').onclick=t=>e.deleteEntry(n.id),c.querySelector('slot[name="autotimer-name"]').innerHTML=n.name,c.querySelector(".icon__state").textContent=n.enabled?"av_timer":"highlight_off",c.querySelector('slot[name="autotimer-searchType"]').innerHTML=l?`${l}:`:"",n.timespanFrom&&(c.querySelector('slot[name="autotimer-timespan"]').innerHTML=`~ ${n.timespanFrom||""} - ${n.timespanTo||""}`),n.isRestrictedByDay&&(c.querySelector('slot[name="autotimer-filters"]').innerHTML="Certain days"),c.querySelector('slot[name="autotimer-channels"]').innerHTML=n.channelNames.join(", "),n.bouquetNames.length&&(c.querySelector('slot[name="autotimer-bouquets"]').innerHTML=`<br> ${n.bouquetNames.join(", ")}`),c.querySelector('slot[name="autotimer-match"]').innerHTML=`"${n.match}"`,t.appendChild(c)})),e.allLocations=[...new Set(e.availableLocations.concat(o))].sort()||[],e.allTags=[...new Set(e.availableTags.concat(s))].sort()||[]}))},getSettings:async()=>{const t="config.plugins.autotimer.";let a=(await owif.utils.fetchData("/autotimer/get")).e2settings.e2setting;const{elements:n}=l;a=a.filter((e=>e.e2settingname.startsWith(t))).map((e=>{for(const[t,a]of Object.entries(e))e[t.replace("e2setting","")]=a,delete e[t];return e.name=e.name.replace(t,""),e}));for(let t of Object.values(a))o(e,n,t.name,t.value)},saveSettings:async()=>{const e=new FormData(l);for(const[t,a]of Object.entries(l))"checkbox"!==a.type||e.has(a.name)||e.set(a.name,"");try{const t=(await owif.utils.fetchData("/autotimer/set",{method:"post",body:e})).e2simplexmlresult,a=t.e2state;let n=t.e2statetext;if(n=`${n.charAt(0).toUpperCase()}${n.slice(1)}`,!0!==a&&"true"!==a.toString().toLowerCase())throw new Error(n)}catch(e){swal({title:tstr_oops,text:e,type:"error",animation:"none"})}},process:async()=>{try{owif.utils.debugLog("`process` started, this could take a while...");const e=(await owif.utils.fetchData("/autotimer/parse")).e2simplexmlresult,t=e.e2state;let a=e.e2statetext;if(a=`${a.charAt(0).toUpperCase()}${a.slice(1)}`,!0!==t&&"true"!==t.toString().toLowerCase())throw new Error(a);swal({title:"result",text:a,type:"info",animation:"none"})}catch(e){swal({title:tstr_oops,text:e.message,type:"error",animation:"none"})}},previewAll:()=>{e.preview()},preview:async(e="")=>{const t=document.getElementById("at-preview__list"),a=document.getElementById("at-preview__no-results"),n=document.getElementById("at-preview__progress");t.querySelectorAll("tr").forEach((e=>e.remove())),a.classList.toggle("hidden",!0),n.classList.toggle("hidden",!1);const o=e&&`test?id=${e}`||"simulate",s=await owif.utils.fetchData(`/autotimer/${o}`),r=s.e2autotimersimulate||s.e2autotimertest,i=r.e2simulatedtimer||r.e2testtimer||[],l=document.createElement("tbody");n.classList.toggle("hidden",!0),i.forEach((e=>{((e,t)=>{const a=e.insertRow(),n=t.e2state;c(a,n).title="Skip"===n?t.e2message:"",c(a,t.e2autotimername),c(a,t.e2name),c(a,t.e2servicename);const o=t.e2timebegin;c(a,owif.utils.getStrftime(o)).style.textAlign="right";const s=t.e2timeend;c(a,owif.utils.getToTimeText(o,s)).style.textAlign="right"})(l,e)})),i.length?t.innerHTML=l.cloneNode(!0).innerHTML:a.classList.toggle("hidden",!1)},prepareChoices:()=>{e.allTags=e.allTags.map((e=>({value:e,label:e}))),e.autoTimerChoices.tag.setChoices(e.allTags,"value","label",!0),e.autoTimerChoices.bouquets.setChoices(e.availableServices.bouquets,"sRef","name",!0),e.autoTimerChoices.services.setChoices(e.availableServices.channels,"sRef","extendedName",!0)},populateForm:async(t={})=>{owif.utils.debugLog(t);const{elements:a}=i;i.reset(),n(".at__filter__line"),document.getElementById("at__page--list").classList.toggle("hidden",!0),window.scroll({top:0,left:0,behavior:"smooth"}),document.getElementById("at__page--edit").classList.toggle("hidden",!1),t=((e={})=>(e._timespan=!!e.timespanFrom||!!e.timespanTo,e._datespan=!!e.after||!!e.before,e._after=!!e.after,e._before=!!e.before,e._timerOffset=!!e.offset,e.timeSpanAE=!!e.afterevent,e._location=!!e.location,e))(t=new r(t)),e.prepareChoices();for(let t of e.allLocations){const e=document.createElement("option");e.appendChild(document.createTextNode(t)),e.value=t,document.querySelector('select[name="location"] optgroup[name="more"').appendChild(e),jQuery("select[name=location]").selectpicker("refresh")}for(let[n,s]of Object.entries(t))o(e,a,n,s);e.populateFilters(t.filters)},deleteEntry:async(t=-1)=>{-1!==t&&swal({title:tstr_del_autotimer,type:"warning",showCancelButton:!0,confirmButtonColor:"#dd6b55",confirmButtonText:tstrings_yes_delete,cancelButtonText:tstrings_no_cancel,closeOnConfirm:!0,closeOnCancel:!0,animation:"none"},(async a=>{if(a){const a=(await owif.utils.fetchData(`/autotimer/remove?id=${t}`)).e2simplexmlresult,n=a.e2state;let o=a.e2statetext;o=`${o.charAt(0).toUpperCase()}${o.slice(1)}`,!0===n||"true"===n.toString().toLowerCase()?swal({title:tstrings_deleted,text:o,type:"success",animation:"none"}):swal({title:tstr_oops,text:o,type:"error",animation:"none"}),e.populateList()}else swal({title:tstrings_cancelled,type:"error",animation:"none"})}))},toggleEntryEnabled:async(t=-1,a)=>{const n=1==a?0:1;try{const o=(await owif.utils.fetchData(`/autotimer/change?id=${t}&enabled=${n}`)).e2simplexmlresult,s=o.e2state;let r=o.e2statetext;if(r=`${r.charAt(0).toUpperCase()}${r.slice(1)}`,!0!==s&&"true"!==s.toString().toLowerCase())throw new Error(r);swal.close(),e.populateList(),owif.utils.debugLog(`toggleEntryEnabled [id ${t}] from ${a} to ${n} successful`)}catch(e){swal({title:tstr_oops,text:e.message,type:"error",animation:"none"})}},createEntry:()=>e.populateForm(),renameEntry:(t=-1,a,n="")=>{const o=async(t,n)=>{try{const o=(await owif.utils.fetchData(`/autotimer/change?id=${t}&name=${n}`)).e2simplexmlresult,s=o.e2state;let r=o.e2statetext;if(r=`${r.charAt(0).toUpperCase()}${r.slice(1)}`,!0!==s&&"true"!==s.toString().toLowerCase())throw new Error(r);swal.close(),e.populateList(),owif.utils.debugLog(`renameEntry [id ${t}] from ${a} to ${n} successful`)}catch(e){swal({title:tstr_oops,text:e.message,type:"error",animation:"none"})}};n?o(t,n):swal({title:tstr_rename,text:"",type:"input",showCancelButton:!0,closeOnConfirm:!1,inputValue:a,input:"text",animation:"none"},(e=>{e&&e.length&&o(t,e)}))},editEntry:async(t=-1)=>{const a=e.allAutoTimers.find((e=>e.id==t));owif.utils.debugLog(`editEntry: ${a}`),e.populateForm(a)},transformFormData:()=>{const e=new FormData(i),t=Object.fromEntries(e),a=["title","shortdescription","description","dayofweek","!title","!shortdescription","!description","!dayofweek"],n=a.concat(["enabled","offset","services","bouquets","vps_enabled"]),o=["offset","services","bouquets"];window.disableFilterEditing&&a.forEach((t=>e.delete(t)));const s="1"==e.get("justplay"),r="1"==e.get("always_zap");return e.set("justplay",!r&&s?"1":"0"),e.set("always_zap",r&&s?"1":"0"),["hasMismatchedService","_before","_after","_type","_filterpredicate","_filterwhere"].forEach((t=>e.delete(t))),Object.entries(t).forEach((([t,a])=>{owif.utils.debugLog(t,a),o.includes(t)&&e.set(t,e.getAll(t)),""===a||","===a?e.delete(t):owif.utils.regexDateFormat.test(a)&&e.set(t,owif.utils.toUnixDate(a))})),n.forEach((t=>{e.has(t)||e.set(t,"")})),e},saveEntry:async(t="")=>{const a=(await owif.utils.fetchData(`/autotimer/edit?${t}`,{method:"post",body:e.transformFormData()})).e2simplexmlresult,n=a.e2state;let o=a.e2statetext;o=`${o.charAt(0).toUpperCase()}${o.slice(1)}`,!0===n||"true"===n.toString().toLowerCase()?e.populateList():swal({title:tstr_oops,text:o,type:"error",animation:"none"})},cancelEntry:()=>{swal({title:tstr_prompt_save_changes,type:"warning",showCancelButton:!0,confirmButtonColor:"#dd6b55",confirmButtonText:tstrings_yes,cancelButtonText:tstrings_no_cancel,closeOnConfirm:!1,closeOnCancel:!0,animation:"none"},(function(t){t?e.saveEntry():(window.location.hash="/at",e.populateList())}))},populateFilters:t=>{t.exclude.forEach((t=>{t.predicate="!",t.value=t["_@ttribute"],delete t["_@ttribute"],e.addFilter(t)})),t.include.forEach((t=>{t.predicate="",t.value=t["_@ttribute"],delete t["_@ttribute"],e.addFilter(t)}))},addFilter:(t={predicate:"",where:"title",value:""})=>{const a=document.getElementById("autotimer-filter-template").content.firstElementChild.cloneNode(!0),n=document.getElementById("atform__filters-container"),o=a.querySelector('select[name="_filterpredicate"]'),s=a.querySelector('select[name="_filterwhere"]'),r=a.querySelector('input[type="text"]'),i=a.querySelector('select[name="dayofweek"]'),l=()=>{"dayofweek"===s.value?(i.name=`${o.value}${s.value}`,r.value=""):(r.name=`${o.value}${s.value}`,i.value="")};if(a.querySelector('button[name="removeFilter"]').onclick=e.removeFilter,o.onchange=e=>{l()},s.onchange=e=>{const t=e.target,a=t.closest("fieldset"),n="dayofweek"===t.value;a.querySelector(".filter-value--dayofweek").classList.toggle("hidden",!n),a.querySelector(".filter-value--text").classList.toggle("hidden",n),l()},o.value=t.predicate,s.value=t.where,"dayofweek"===t.where){const e=t.value.split(",");for(let t of i)t.selected=e.includes(t.value);s.dispatchEvent(new Event("change"))}else r.value=t.value;l(),n.appendChild(a),jQuery.AdminBSB.select.activate()},removeFilter:()=>{event.target.closest("fieldset.at__filter__line").remove()},initEventHandlers:()=>{let t=document.createElement("input");(document.querySelector('button[name="reload"]')||t).onclick=e.populateList,(document.querySelector('button[name="process"]')||t).onclick=e.process,(document.querySelector('button[name="previewAll"]')||t).onclick=e.previewAll,(document.querySelector('button[name="timers"]')||t).onclick=()=>window.listTimers(),(document.querySelector('button[name="settings"]')||t).onclick=e.getSettings,(document.querySelector('button[name="saveSettings"]')||t).onclick=e.saveSettings,(document.querySelector('a[href="/#/at/new"]')||t).onclick=e.createEntry,(document.querySelector('button[name="addFilter"]')||t).onclick=()=>e.addFilter(),(document.querySelector('button[name="cancel"]')||t).onclick=e.cancelEntry,(document.querySelector('form[name="atedit"]')||t).onsubmit=t=>{t.preventDefault(),e.saveEntry()},(document.querySelectorAll('input[name="justplay"], input[name="always_zap"]')||t).forEach((e=>{e.onchange=e=>{const t=document.querySelector('input[name="justplay"]').checked,a=document.querySelector('input[name="always_zap"]').checked;e.target.checked||a||t||(e.target.checked=!0)}})),(document.getElementById("_timespan")||t).onchange=e=>{s(document.getElementById("_timespan_"),!e.target.checked)},(document.getElementById("_datespan")||t).onchange=e=>{s(document.getElementById("_datespan_"),!e.target.checked)},(document.getElementById("_timerOffset")||t).onchange=e=>{s(document.getElementById("_timerOffset_"),!e.target.checked)},(document.querySelector('[name="afterevent"]')||t).onchange=e=>{s(document.getElementById("AftereventE"),!e.target.value)},(document.getElementById("timeSpanAE")||t).onchange=e=>{s(document.getElementById("timeSpanAEE"),!e.target.checked)},(document.getElementById("_location")||t).onchange=e=>{s(document.getElementById("_location_"),!e.target.checked)},(document.getElementById("beforeevent")||t).onchange=e=>{s(document.getElementById("BeforeeventE"),!e.target.checked)},(document.querySelector('[name="vps_enabled"]')||t).onchange=e=>{s(document.getElementById("vps_enabled_"),!e.target.checked)},(document.querySelector('[name="vps_safemode"]')||t).onchange=e=>{(document.querySelector('[name="vps_overwrite"]')||t).value=e.target.checked?0:1}},init:async function(){e=this,e.allAutoTimers=[],e.availableServices=await owif.api.getAllServices(!0,!0),e.availableLocations=[],e.allLocations=[],e.availableTags=await owif.api.getTags(),e.allTags=[],e.autoTimerChoices=owif.gui.preparedChoices();const t=window.location.hash;if(t.startsWith("/#/at/new")){const n=new URLSearchParams(t.split("?")[1]||""),o=Object.fromEntries(n);o.timespanFrom&&(o.timespanFrom=a(o.timespanFrom,{hours:-1})),o.timespanTo&&(o.timespanTo=a(o.timespanTo,{hours:1})),o.sref&&(o.e2service={e2servicereference:o.sref}),e.populateForm(o)}else if(t.startsWith("/#/at/edit")){const a=new URLSearchParams(t.split("?")[1]||"");e.editEntry(a.get("id"))}else e.populateList();e.initEventHandlers(e)}}}).init()}();